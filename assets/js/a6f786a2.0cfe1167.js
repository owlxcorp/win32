"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["6889"],{3197:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>r,default:()=>h,contentTitle:()=>o,assets:()=>a,toc:()=>l,metadata:()=>t});var t=JSON.parse('{"id":"guides-concepts/com/basic-concepts","title":"Basic Concepts","description":"Since the win32 package primarily focuses on providing a lightweight","source":"@site/docs/guides-concepts/com/basic-concepts.md","sourceDirName":"guides-concepts/com","slug":"/guides-concepts/com/basic-concepts","permalink":"/docs/guides-concepts/com/basic-concepts","draft":false,"unlisted":false,"editUrl":"https://github.com/halildurmus/win32/tree/main/website/docs/guides-concepts/com/basic-concepts.md","tags":[],"version":"current","lastUpdatedBy":"Sol Birnbaum","lastUpdatedAt":1744291582000,"frontMatter":{"title":"Basic Concepts"},"sidebar":"mainSidebar","previous":{"title":"COM","permalink":"/docs/com"},"next":{"title":"Strings","permalink":"/docs/guides-concepts/com/strings"}}'),c=i(5893),s=i(65);let r={title:"Basic Concepts"},o=void 0,a={},l=[{value:"Initializing the COM Library",id:"initializing-the-com-library",level:2},{value:"Creating COM Objects",id:"creating-com-objects",level:2},{value:"Requesting an Interface from a COM Object",id:"requesting-an-interface-from-a-com-object",level:2},{value:"Calling Methods on a COM Object",id:"calling-methods-on-a-com-object",level:2},{value:"Releasing COM Objects",id:"releasing-com-objects",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,s.a)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(n.p,{children:["Since the ",(0,c.jsx)(n.strong,{children:"win32"})," package primarily focuses on providing a ",(0,c.jsx)(n.strong,{children:"lightweight\nwrapper"})," for the underlying Windows API primitives, you can use the same API\ncalls as described in Microsoft documentation to create and manipulate objects\n(e.g., ",(0,c.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance",children:(0,c.jsx)(n.code,{children:"CoCreateInstance"})})," and\n",(0,c.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(refiid_void)",children:(0,c.jsx)(n.code,{children:"IUnknown->QueryInterface"})}),")."]}),"\n",(0,c.jsxs)(n.p,{children:["However, this approach introduces a certain amount of ",(0,c.jsx)(n.strong,{children:"boilerplate"})," and\n",(0,c.jsx)(n.strong,{children:"non-idiomatic Dart"})," code. To address this, the library provides ",(0,c.jsx)(n.strong,{children:"helper\nfunctions"})," that reduce the labor compared to a pure C-style calling convention."]}),"\n",(0,c.jsx)(n.h2,{id:"initializing-the-com-library",children:"Initializing the COM Library"}),"\n",(0,c.jsxs)(n.p,{children:["Before calling any COM APIs, you must first ",(0,c.jsx)(n.strong,{children:"initialize"})," the COM library by\ncalling the ",(0,c.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/combaseapi/nf-combaseapi-coinitializeex",children:(0,c.jsx)(n.code,{children:"CoInitializeEx"})})," function. Details of the\nthreading models are outside the scope of this guide, but typically, you should\nwrite something like this:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-dart",children:"final hr = CoInitializeEx(\n    nullptr, COINIT_APARTMENTTHREADED | COINIT_DISABLE_OLE1DDE);\nif (FAILED(hr)) throw WindowsException(hr);\n"})}),"\n",(0,c.jsx)(n.h2,{id:"creating-com-objects",children:"Creating COM Objects"}),"\n",(0,c.jsxs)(n.p,{children:["You can create COM objects using the ",(0,c.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance",children:(0,c.jsx)(n.code,{children:"CoCreateInstance"})}),"\nfunction:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-dart",children:"hr = CoCreateInstance(clsid, nullptr, CLSCTX_INPROC_SERVER, iid, ppv);\n"})}),"\n",(0,c.jsxs)(n.p,{children:["However, instead of manually allocating ",(0,c.jsx)(n.code,{children:"GUID"})," structs for the ",(0,c.jsx)(n.code,{children:"clsid"})," and ",(0,c.jsx)(n.code,{children:"iid"}),"\nvalues, checking the ",(0,c.jsx)(n.code,{children:"hr"})," result code, and dealing with casting the ",(0,c.jsx)(n.code,{children:"ppv"})," return\nobject, it is easier to use the ",(0,c.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/COMObject/createFromID.html",children:(0,c.jsx)(n.code,{children:"createFromID"})})," static helper\nfunction:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-dart",children:"final fileDialog2 = IFileDialog2(\n    COMObject.createFromID(CLSID_FileOpenDialog, IID_IFileDialog2));\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"createFromID"})," returns a ",(0,c.jsx)(n.code,{children:"Pointer<COMObject>"})," containing the requested object,\nwhich can then be ",(0,c.jsx)(n.strong,{children:"cast"})," into the appropriate interface as shown above. This\napproach ",(0,c.jsx)(n.strong,{children:"simplifies"})," the creation process and ",(0,c.jsx)(n.strong,{children:"reduces"})," boilerplate code."]}),"\n",(0,c.jsx)(n.h2,{id:"requesting-an-interface-from-a-com-object",children:"Requesting an Interface from a COM Object"}),"\n",(0,c.jsxs)(n.p,{children:["COM objects can implement multiple interfaces, but you cannot simply cast an\nobject to a different interface. Instead, pointers are returned to a specific\ninterface. Every COM interface in the ",(0,c.jsx)(n.strong,{children:"win32"})," package derives from ",(0,c.jsx)(n.code,{children:"IUnknown"}),",\nallowing you to call ",(0,c.jsx)(n.code,{children:"queryInterface"})," on any object to retrieve a pointer to a\ndifferent supported interface."]}),"\n",(0,c.jsxs)(n.p,{children:["For more information on COM interfaces, refer to the ",(0,c.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/learnwin32/asking-an-object-for-an-interface",children:"Microsoft documentation"}),"."]}),"\n",(0,c.jsxs)(n.p,{children:["COM interfaces provide a method that wraps ",(0,c.jsx)(n.code,{children:"queryInterface"}),". If you have an\nexisting COM object, you can call it as follows:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-dart",children:"  final modalWindow = IModalWindow(fileDialog2.toInterface(IID_IModalWindow));\n"})}),"\n",(0,c.jsxs)(n.p,{children:["Alternatively, you can use the ",(0,c.jsx)(n.code,{children:"from"})," constructor that wraps ",(0,c.jsx)(n.code,{children:"toInterface"})," for\nyou:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-dart",children:"  final modalWindow = IModalWindow.from(fileDialog2);\n"})}),"\n",(0,c.jsxs)(n.p,{children:["While ",(0,c.jsx)(n.code,{children:"createFromID"})," creates a new COM object, ",(0,c.jsx)(n.code,{children:"toInterface"})," casts an existing\nCOM object to a new interface."]}),"\n",(0,c.jsxs)(n.p,{children:["Attempting to cast a COM object to an unsupported interface will fail, and a\n",(0,c.jsx)(n.code,{children:"WindowsException"})," will be thrown with an ",(0,c.jsx)(n.code,{children:"hr"})," of ",(0,c.jsx)(n.code,{children:"E_NOINTERFACE"}),"."]}),"\n",(0,c.jsx)(n.h2,{id:"calling-methods-on-a-com-object",children:"Calling Methods on a COM Object"}),"\n",(0,c.jsxs)(n.p,{children:["When calling methods on a COM object, it's wise to assign the ",(0,c.jsx)(n.strong,{children:"return value"}),"\nto a variable and test it for ",(0,c.jsx)(n.strong,{children:"success"})," or ",(0,c.jsx)(n.strong,{children:"failure"}),". You can use the\n",(0,c.jsx)(n.code,{children:"SUCCEEDED()"})," or ",(0,c.jsx)(n.code,{children:"FAILED()"})," functions for this purpose."]}),"\n",(0,c.jsx)(n.p,{children:"For example:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-dart",children:"final hr = fileOpenDialog.show(NULL);\nif (SUCCEEDED(hr)) {\n  // Do something with the returned dialog box values.\n}\n"})}),"\n",(0,c.jsxs)(n.p,{children:["Failures are reported as ",(0,c.jsx)(n.code,{children:"HRESULT"})," values (e.g., ",(0,c.jsx)(n.code,{children:"E_ACCESSDENIED"}),").\nOccasionally, a Win32 error code is converted to an ",(0,c.jsx)(n.code,{children:"HRESULT"}),", such as when a\nuser cancels a common dialog box:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-dart",children:"final hr = fileOpenDialog.show(NULL);\nif (FAILED(hr) && hr == HRESULT_FROM_WIN32(ERROR_CANCELLED)) {\n  // User clicked cancel.\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"releasing-com-objects",children:"Releasing COM Objects"}),"\n",(0,c.jsxs)(n.p,{children:["In general, releasing COM objects isn't something you need to worry about\nbecause when the object becomes inaccessible to the program, the\n",(0,c.jsx)(n.a,{href:"https://api.dart.dev/stable/dart-core/Finalizer-class.html",children:(0,c.jsx)(n.code,{children:"Finalizer"})})," ",(0,c.jsx)(n.em,{children:"automatically"})," ",(0,c.jsx)(n.strong,{children:"releases"})," it for you."]}),"\n",(0,c.jsxs)(n.admonition,{type:"warning",children:[(0,c.jsxs)(n.p,{children:["If you are manually managing the lifetime of an object, such as by calling the\n",(0,c.jsx)(n.code,{children:".detach()"})," method, it is important to ensure that you release it properly by\ncalling the ",(0,c.jsx)(n.code,{children:".release()"})," method. Additionally, you should free up the memory\nthat was allocated for the object by calling the ",(0,c.jsx)(n.code,{children:"free()"})," helper function as\nfollows:"]}),(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-dart",children:"fileOpenDialog.release(); // Release the COM object.\nfree(fileOpenDialog.ptr); // Release the allocated memory for the object.\n"})}),(0,c.jsxs)(n.p,{children:["This is necessary to prevent ",(0,c.jsx)(n.strong,{children:"memory leaks"})," and ensure that the memory used by\nthe object is properly released."]}),(0,c.jsx)(n.admonition,{type:"simple",children:(0,c.jsxs)(n.p,{children:["It is important to include this code as part of a ",(0,c.jsx)(n.code,{children:"try"}),"/",(0,c.jsx)(n.code,{children:"finally"})," block to\nensure that the object is ",(0,c.jsx)(n.strong,{children:"released"})," properly, even if an ",(0,c.jsx)(n.strong,{children:"exception"})," is\nthrown during the execution of your code."]})})]})]})}function h(e={}){let{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}}}]);